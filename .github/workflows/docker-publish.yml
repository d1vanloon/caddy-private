name: Build and Publish Docker Image

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract Caddy version from Dockerfile
      id: caddy-version
      run: |
        CADDY_VERSION=$(grep -oP 'FROM caddy:\K[^-]+' Dockerfile | head -1)
        echo "version=$CADDY_VERSION" >> $GITHUB_OUTPUT
        echo "major=$(echo $CADDY_VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT
        echo "minor=$(echo $CADDY_VERSION | cut -d. -f1-2)" >> $GITHUB_OUTPUT

    - name: Generate tags based on context
      id: tags
      run: |
        CADDY_VERSION="${{ steps.caddy-version.outputs.version }}"
        CADDY_MINOR="${{ steps.caddy-version.outputs.minor }}"
        CADDY_MAJOR="${{ steps.caddy-version.outputs.major }}"
        
        # Initialize tags array
        TAGS=()
        
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PR builds: Caddy version + PR number
          TAGS+=("${CADDY_VERSION}-pr${{ github.event.number }}")
          TAGS+=("${CADDY_MINOR}-pr${{ github.event.number }}")
          TAGS+=("${CADDY_MAJOR}-pr${{ github.event.number }}")
        elif [ "${{ github.ref_name }}" = "main" ] || [ "${{ github.ref_name }}" = "master" ]; then
          # Main/master branch: Clean Caddy version tags
          TAGS+=("${CADDY_VERSION}")
          TAGS+=("${CADDY_MINOR}")
          TAGS+=("${CADDY_MAJOR}")
          TAGS+=("latest")
        else
          # Other branches: Caddy version + branch name (sanitized)
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          TAGS+=("${CADDY_VERSION}-${BRANCH_NAME}")
          TAGS+=("${CADDY_MINOR}-${BRANCH_NAME}")
          TAGS+=("${CADDY_MAJOR}-${BRANCH_NAME}")
        fi
        
        # Convert array to newline-separated string for output
        printf '%s\n' "${TAGS[@]}" > tags.txt
        echo "Generated tags:"
        cat tags.txt
        
        # Set output for use in docker/metadata-action
        echo "tags<<EOF" >> $GITHUB_OUTPUT
        cat tags.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: ${{ steps.tags.outputs.tags }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Auto-merge Dependabot PRs
      if: github.event_name == 'pull_request' && github.actor == 'dependabot[bot]' && success()
      run: |
        gh pr merge --auto --squash "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}